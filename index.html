<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0b1024"/>
  <title>Curso ChatGPT ¬∑ Generador docente (LOMLOE) ‚Äî m√≥vil</title>
  <meta name="description" content="Una sola p√°gina m√≥vil para profes: genera prompts (base + ajustes + documentaci√≥n), mejora por conversaci√≥n y usa plantillas. Incluye prompt final + copiar + compartir enlace + abrir ChatGPT."/>

  <style>
    :root{
      --bg:#0b1024; --surface:#101833; --text:#eef2ff; --muted:#a7b5d7;
      --brand:#7aa7ff; --accent:#79e6b5; --border:#1f2745; --code:#0b1331;
      --radius:16px; --maxw:860px; --pad:14px; --tap:44px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --bottomBar: 64px;
      --danger:#ff6b6b;
      --ok:#4ade80;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8ff; --surface:#ffffff; --text:#0d1533; --muted:#475569; --border:#e3e8f5; --code:#f1f4fb }
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg); color:var(--text);
      line-height:1.7;
      text-rendering:optimizeLegibility;
    }
    a{color:var(--brand);text-decoration:none}
    p,li,summary,h1,h2,h3{overflow-wrap:anywhere;word-break:break-word;hyphens:auto}

    header{
      position:sticky;top:0;z-index:40;
      background:rgba(16,24,51,.95);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border)
    }
    .row{display:flex;align-items:center;gap:10px;height:56px;padding:0 var(--pad)}
    .logo{width:24px;height:24px;border-radius:8px;background:conic-gradient(from 200deg,var(--brand),var(--accent),var(--brand))}
    .brand{display:flex;align-items:center;gap:10px;font-weight:850}
    .grow{flex:1}

    .btn{
      appearance:none;border:1px solid var(--border);background:var(--surface);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;min-height:var(--tap);
      font-size:15px;transition:.15s ease;display:inline-flex;justify-content:center;align-items:center;gap:8px;
      text-align:center;
    }
    .btn.primary{background:linear-gradient(180deg,#2c52ff,#2136a8);border-color:#2e43c7}
    .btn.ghost{background:transparent}
    .btn:active{transform:scale(.99)}

    .container{width:min(96vw,var(--maxw));margin:0 auto;padding:var(--pad)}
    .hero{
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(640px 280px at 0% 0%, rgba(122,167,255,.22), transparent 60%),
        radial-gradient(640px 280px at 100% 0%, rgba(121,230,181,.16), transparent 60%)
    }
    h1{font-size:clamp(22px,6vw,30px);margin:10px 0 6px}
    .lead{color:var(--muted);margin:2px 0 10px}

    /* Step bar */
    .steps{
      display:flex;gap:8px;overflow-x:auto;padding:6px 0 10px;margin:6px 0 0;
      scroll-snap-type:x mandatory
    }
    .steps::-webkit-scrollbar{display:none}
    .step{
      scroll-snap-align:start;
      flex:0 0 auto;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap
    }
    .step.active{color:var(--text);border-color:rgba(122,167,255,.6);background:rgba(122,167,255,.08)}

    section{scroll-margin-top:74px}
    .card{
      background:var(--surface);border:1px solid var(--border);
      border-radius:var(--radius);padding:14px;margin:10px 0;
      box-shadow:0 4px 16px rgba(10,20,40,.22);
      overflow:hidden
    }
    h2{margin:0 0 8px;font-size:18px}
    h3{margin:14px 0 8px;font-size:16px}

    /* Controls */
    .builder{display:grid;grid-template-columns:1fr;gap:10px}
    .row2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){ .row2{grid-template-columns:1fr 1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select,textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-size:15px;
      min-height:var(--tap);
      outline:none;
    }
    textarea{
      min-height:140px;
      resize:vertical;
      white-space:pre-wrap;
      overflow:auto;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    .invalid input,.invalid select,.invalid textarea,
    input.invalid, select.invalid, textarea.invalid{
      border-color:rgba(255,107,107,.95) !important;
      box-shadow:0 0 0 3px rgba(255,107,107,.18);
    }

    /* Collapsibles */
    details{
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(255,255,255,.02);
      padding:8px 10px
    }
    details + details{margin-top:10px}
    summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      width:22px;height:22px;border-radius:8px;
      background:rgba(122,167,255,.18);
      border:1px solid rgba(122,167,255,.45);
      color:var(--text);
      font-size:12px;
      flex:0 0 auto
    }

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      background:rgba(255,255,255,.02);
      white-space:normal;
      line-height:1.35;
      max-width:100%;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .chip.active{background:rgba(122,167,255,.15);border-color:rgba(122,167,255,.6)}

    /* Code blocks */
    pre{
      background:var(--code);
      border:1px solid var(--border);
      border-radius:12px;
      padding:40px 12px 12px 12px;
      overflow:auto;
      position:relative;
      max-width:100%;
      white-space:pre;
    }
    code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:13px}
    .copy{position:absolute;top:8px;right:8px;font-size:12px}

    /* Bottom bar */
    .bottom{
      position:sticky;bottom:0;z-index:50;
      background:rgba(16,24,51,.96);backdrop-filter:blur(10px);
      border-top:1px solid var(--border);
    }
    .bottom .bar{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      padding:10px var(--pad);
      padding-bottom:calc(10px + var(--safeB));
      min-height:calc(var(--bottomBar) + var(--safeB));
    }
    .bottom .btn{flex:1}
    main{padding-bottom:calc(var(--bottomBar) + var(--safeB) + 18px)}

    /* Bottom "M√°s" panel */
    .more-panel{
      position:fixed;
      left:0; right:0;
      bottom:calc(var(--bottomBar) + var(--safeB));
      padding:10px var(--pad);
      z-index:60;
      display:none;
    }
    .more-card{
      width:min(96vw,var(--maxw));
      margin:0 auto;
      background:rgba(16,24,51,.98);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .more-head{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.02);
      font-weight:850;
    }
    .more-actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      padding:12px;
    }
    .more-actions .btn{width:100%}
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      z-index:55;
      display:none;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(var(--bottomBar) + var(--safeB) + 16px);
      background:rgba(0,0,0,.75);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      z-index:80;
      display:none;
      max-width:min(92vw,520px);
      text-align:center;
      border:1px solid rgba(255,255,255,.15);
      backdrop-filter: blur(8px);
    }

    /* Small helper line */
    .micro{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      padding:6px 10px;border-radius:999px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(122,167,255,.8)}
  </style>
</head>

<body>
  <header>
    <div class="row">
      <div class="brand"><div class="logo" aria-hidden="true"></div><div>Generador docente ¬∑ LOMLOE (Canarias)</div></div>
      <div class="grow"></div>
      <button class="btn" id="theme" type="button">Tema</button>
      <button class="btn primary" type="button" onclick="window.print()">PDF</button>
    </div>
  </header>

  <div class="hero">
    <div class="container">
      <h1>ChatGPT para profes: genera y mejora prompts</h1>
      <p class="lead">Dise√±ado para m√≥vil: rellena lo m√≠nimo, genera el prompt final y p√©galo en ChatGPT. Luego mejora ‚Äúen conversaci√≥n‚Äù.</p>

      <div class="micro" aria-label="Gu√≠a r√°pida">
        <span class="tag"><span class="dot"></span> 1) Generar</span>
        <span class="tag"><span class="dot" style="background:rgba(121,230,181,.9)"></span> 2) Mejorar</span>
        <span class="tag"><span class="dot" style="background:rgba(255,255,255,.55)"></span> 3) Plantillas</span>
      </div>

      <div class="steps" id="steps">
        <a class="step" href="#generar">1) Generar</a>
        <a class="step" href="#mejorar">2) Mejorar</a>
        <a class="step" href="#plantillas">3) Plantillas</a>
      </div>
    </div>
  </div>

  <main>
    <div class="container">

      <!-- 1) GENERAR -->
      <section id="generar" class="card">
        <h2>1) Generar el prompt</h2>
        <p class="lead">Empieza por el ‚Äúprompt base‚Äù. Si necesitas m√°xima precisi√≥n, abre ‚ÄúAjustes finos‚Äù y/o ‚ÄúOrden + ejemplo‚Äù.</p>

        <h3>Prompt base</h3>
        <div class="builder">

          <div class="row2">
            <div>
              <label>Producto</label>
              <div class="hint">El producto define el tipo de salida (Prueba/SdA/R√∫brica‚Ä¶).</div>
              <select id="p-producto">
                <option value="prueba (evaluaci√≥n)" selected>Prueba (evaluaci√≥n)</option>
                <option value="situaci√≥n de aprendizaje (SdA) con producto final">Situaci√≥n de aprendizaje (SdA)</option>
                <option value="tarea competencial (actividad final + evaluaci√≥n)">Tarea competencial</option>
                <option value="r√∫brica (4 niveles) con descriptores observables">R√∫brica (4 niveles)</option>
                <option value="programaci√≥n de unidad/SdA por apartados (LOMLOE)">Programaci√≥n (unidad/SdA)</option>
                <option value="adaptaci√≥n curricular individualizada (NEAE) ‚Äî objetivos, actividades y evaluaci√≥n adaptada">Adaptaci√≥n curricular (NEAE)</option>
                <option value="gu√≠a docente para impartir un tema (plan de sesiones + recursos + evaluaci√≥n)">Gu√≠a docente (plan de sesiones)</option>
                <option value="guion de diapositivas para Overleaf/LaTeX Beamer">Diapositivas (Overleaf/LaTeX)</option>
                <option value="cuestionario Moodle en formato GIFT">Cuestionario Moodle (GIFT)</option>
              </select>
            </div>

            <div>
              <label>Materia</label>
              <input id="p-materia" placeholder="p.ej., Matem√°ticas / Lengua / Biolog√≠a‚Ä¶"/>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Etapa</label>
              <select id="p-etapa">
                <option>Primaria</option>
                <option selected>ESO</option>
                <option>Bachillerato</option>
                <option>FP B√°sica</option>
                <option>Grado Medio (FP)</option>
                <option>Grado Superior (FP)</option>
              </select>
            </div>

            <div>
              <label>Curso</label>
              <select id="p-curso">
                <option selected>1.¬∫</option><option>2.¬∫</option><option>3.¬∫</option><option>4.¬∫</option><option>5.¬∫</option><option>6.¬∫</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Objetivo did√°ctico (1 frase)</label>
              <input id="p-objetivo" placeholder="p.ej., resolver problemas en contexto y justificar el procedimiento"/>
            </div>
            <div>
              <label>Perfil del grupo</label>
              <input id="p-perfil" placeholder="p.ej., grupo heterog√©neo; NEAE; ritmos diversos"/>
            </div>
          </div>

          <div class="row2">
            <div>
              <label id="p-metodo-label">Metodolog√≠a (c√≥mo vas a ense√±ar)</label>
              <select id="p-metodo"></select>
              <div class="hint" id="p-metodo-hint">Si el producto es ‚ÄúPrueba‚Äù, aqu√≠ ver√°s ‚ÄúTipo de prueba‚Äù.</div>
            </div>

            <div id="modalidad-wrap">
              <div>
                <label>Din√°mica de aula</label>
                <select id="p-modalidad">
                  <option selected>resoluci√≥n de tareas en aula (pr√°ctica guiada)</option>
                  <option>explicaci√≥n + ejemplos breves</option>
                  <option>taller / laboratorio</option>
                  <option>debate / puesta en com√∫n</option>
                  <option>trabajo cooperativo (roles)</option>
                  <option>indagaci√≥n / aprendizaje por descubrimiento</option>
                  <option>exposici√≥n del alumnado</option>
                  <option>proyecto / producto final</option>
                  <option>retos cortos (10‚Äì15 min) + cierre</option>
                </select>
              </div>
            </div>
          </div>

          <details>
            <summary><span class="pill">+</span> Opciones LOMLOE (competencias / criterios / saberes)</summary>
            <div class="builder" style="margin-top:10px">
              <div class="row2">
                <div>
                  <label>Competencias espec√≠ficas (c√≥digo + texto / resumen)</label>
                  <textarea id="p-comp" placeholder="Ej.: CE1 ‚Äî Resolver problemas en contextos reales‚Ä¶"></textarea>
                </div>
                <div>
                  <label>Competencias clave (opcional)</label>
                  <input id="p-cc" placeholder="CCL, STEM, CD‚Ä¶ (si procede)"/>
                </div>
              </div>
              <div class="row2">
                <div>
                  <label>Criterios de evaluaci√≥n (c√≥digo + texto / resumen)</label>
                  <textarea id="p-criterios" placeholder="Ej.: 2.1 ‚Äî Aplica estrategias de c√°lculo‚Ä¶&#10;2.2 ‚Äî Justifica procedimientos‚Ä¶"></textarea>
                </div>
                <div>
                  <label>Saberes b√°sicos (breve)</label>
                  <input id="p-saberes" placeholder="lista breve o resumen"/>
                </div>
              </div>
              <div class="hint">Tip: pegar criterios/saberes es lo que m√°s sube la calidad (alineaci√≥n real a LOMLOE).</div>
            </div>
          </details>

          <div class="row2">
            <div>
              <label>Tono</label>
              <select id="p-tono">
                <option selected>did√°ctico y claro</option>
                <option>cercano y motivador</option>
                <option>formal y profesional</option>
                <option>muy conciso</option>
              </select>
            </div>
            <div>
              <label>Formato de salida</label>
              <select id="p-formato">
                <option selected>texto por apartados (LOMLOE)</option>
                <option>tabla Markdown (criterio | evidencia | tarea)</option>
                <option>lista numerada paso a paso</option>
                <option>JSON (para importaci√≥n)</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Longitud</label>
              <select id="p-long">
                <option selected>breve</option>
                <option>media</option>
                <option>amplia</option>
              </select>
              <div class="hint">Idioma fijo: <strong>espa√±ol (Canarias)</strong>.</div>
            </div>
          </div>

          <div>
            <label>Activadores r√°pidos</label>
            <div class="chips" id="p-opc">
              <div class="chip" data-key="pasos">Entrega por partes y espera mi OK</div>
              <div class="chip" data-key="dua">Incluye DUA / accesibilidad</div>
              <div class="chip" data-key="codigos">C√≥digos visibles</div>
              <div class="chip" data-key="evidencias">Evidencias + instrumento</div>
              <div class="chip" data-key="preguntas">Preg√∫ntame antes de asumir</div>
            </div>
            <div class="hint">Recomendado: ‚ÄúC√≥digos visibles‚Äù + ‚ÄúEvidencias + instrumento‚Äù + ‚ÄúEntrega por partes‚Äù.</div>
            <div class="hint"><strong>Flujo:</strong> rellena Producto + Materia + Objetivo ‚Üí (opcional) Ajustes/Orden ‚Üí <strong>Generar prompt final</strong> ‚Üí Copiar ‚Üí Pegar en ChatGPT.</div>
          </div>

        </div>

        <h3>Ajustes finos (opcional)</h3>
        <div id="ajustes-wrap">
          <details>
            <summary><span class="pill">A</span> C√≥mo debe responder ChatGPT (rol y estilo)</summary>
            <div class="builder" style="margin-top:10px">
              <div class="row2">
                <div>
                  <label>Rol</label>
                  <select id="a-rol">
                    <option selected>profesor/a (especialista en tu materia)</option>
                    <option>maestro/a (Primaria)</option>
                    <option>maestro/a de Pedagog√≠a Terap√©utica (PT) ‚Äî atenci√≥n a la diversidad</option>
                    <option>docente con experiencia en LOMLOE (programaci√≥n y evaluaci√≥n)</option>
                  </select>
                </div>
                <div>
                  <label>Estilo</label>
                  <select id="a-estilo">
                    <option selected>muy pr√°ctico (listo para aula)</option>
                    <option>riguroso y profesional</option>
                    <option>claro y cercano</option>
                    <option>muy conciso</option>
                  </select>
                </div>
              </div>
              <div>
                <label>Notas de estilo (opcional)</label>
                <input id="a-notas" placeholder="p.ej., lenguaje no violento; instrucciones cortas; ejemplos cotidianos"/>
              </div>
            </div>
          </details>

          <details>
            <summary><span class="pill">B</span> Atenci√≥n a la diversidad (NEAE / ampliaci√≥n)</summary>
            <div class="builder" style="margin-top:10px">
              <div class="row2">
                <div>
                  <label>Apoyos NEAE</label>
                  <select id="a-neae">
                    <option selected>ligero</option>
                    <option>alto</option>
                    <option>ninguno</option>
                  </select>
                </div>
                <div>
                  <label>Ampliaci√≥n (altas capacidades)</label>
                  <select id="a-ac"><option>s√≠</option><option selected>no</option></select>
                </div>
              </div>
              <div class="row2">
                <div>
                  <label>Nivel cognitivo</label>
                  <select id="a-bloom">
                    <option selected>aplicar / resolver</option>
                    <option>comprender / explicar</option>
                    <option>analizar / comparar</option>
                    <option>evaluar / justificar</option>
                    <option>crear / dise√±ar</option>
                  </select>
                </div>
                <div>
                  <label>Ejemplos por bloque/√≠tem</label>
                  <select id="a-ej">
                    <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="0">0</option>
                  </select>
                </div>
              </div>
            </div>
          </details>

          <details>
            <summary><span class="pill">C</span> Evaluaci√≥n (evidencias + instrumento)</summary>
            <div class="builder" style="margin-top:10px">
              <div>
                <label>Evidencias observables (toca para incluir)</label>
                <div class="chips" id="a-evid">
                  <div class="chip">procedimiento y razonamiento</div>
                  <div class="chip">c√°lculo correcto/eficiente</div>
                  <div class="chip">argumentaci√≥n/justificaci√≥n</div>
                  <div class="chip">comunicaci√≥n (orden, vocabulario)</div>
                  <div class="chip">representaciones (diagramas/gr√°ficas)</div>
                  <div class="chip">autoevaluaci√≥n/coevaluaci√≥n</div>
                </div>
              </div>
              <div class="row2">
                <div>
                  <label>Instrumento</label>
                  <select id="a-inst">
                    <option selected>r√∫brica</option>
                    <option>lista de cotejo</option>
                    <option>escala de valoraci√≥n</option>
                    <option>registro de observaci√≥n</option>
                  </select>
                </div>
                <div>
                  <label>Escala / niveles</label>
                  <select id="a-escala">
                    <option selected>4 niveles (Inicial ‚Üí Excelente)</option>
                    <option>Insuficiente / Suficiente / Bien / Notable / Sobresaliente</option>
                    <option>A‚ÄìD con descriptores</option>
                  </select>
                </div>
              </div>
            </div>
          </details>

          <details>
            <summary><span class="pill">D</span> Contexto y restricciones (centro)</summary>
            <div class="builder" style="margin-top:10px">
              <div class="row2">
                <div>
                  <label>Contexto</label>
                  <textarea id="a-contexto" placeholder="p.ej., 55 min; pizarra digital; trabajo por parejas‚Ä¶"></textarea>
                </div>
                <div>
                  <label>Restricciones</label>
                  <textarea id="a-restr" placeholder="p.ej., m√°ximo 1 p√°gina; sin violencia; incluir soluci√≥n; lenguaje accesible‚Ä¶"></textarea>
                </div>
              </div>
              <div class="row2">
                <div>
                  <label>Formato final</label>
                  <select id="a-formato">
                    <option selected>texto por apartados</option>
                    <option>tabla Markdown</option>
                    <option>lista numerada</option>
                    <option>JSON</option>
                  </select>
                </div>
              </div>
            </div>
          </details>
        </div>

        <h3>Orden + ejemplo (opcional)</h3>
        <div id="docs-wrap">
          <details>
            <summary><span class="pill">üìé</span> Pegar orden espec√≠fica y ejemplo</summary>
            <div class="builder" style="margin-top:10px">
              <div class="row2">
                <div>
                  <label>Orden espec√≠fica / condiciones (centro/CCAA)</label>
                  <textarea id="d-orden" placeholder="Pega instrucciones obligatorias: formato, tiempos, evaluaci√≥n, criterios de calificaci√≥n, etc."></textarea>
                </div>
                <div>
                  <label>Ejemplo propio (muy recomendado)</label>
                  <textarea id="d-ejemplo" placeholder="Pega un fragmento bien hecho (examen/SdA/r√∫brica). ChatGPT lo usar√° como est√°ndar (formato, nivel y estilo)."></textarea>
                </div>
              </div>
              <div class="hint">Esto no sustituye tu criterio profesional: te ayuda a que ChatGPT ‚Äúcopie‚Äù tu est√°ndar.</div>
            </div>
          </details>
        </div>

        <h3>Prompt final (listo para pegar)</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="m-build" type="button">Generar prompt final</button>
          <button class="btn" id="m-copy" type="button">Copiar</button>
          <button class="btn" id="m-share" type="button">Compartir enlace</button>
          <button class="btn" id="m-dl" type="button">Descargar .txt</button>
          <a class="btn" id="m-open" href="https://chatgpt.com" target="_blank" rel="noopener">Abrir ChatGPT</a>
        </div>
        <textarea id="m-out" placeholder="Aqu√≠ aparecer√° el prompt final (base + ajustes + documentaci√≥n)‚Ä¶"></textarea>
      </section>

      <!-- 2) MEJORAR -->
      <section id="mejorar" class="card">
        <h2>2) Mejorar por conversaci√≥n</h2>
        <p class="lead">√ösalo despu√©s de la primera respuesta: ‚Äúme gusta, pero hazlo m√°s as√≠‚Ä¶‚Äù.</p>

        <div class="builder">
          <div class="row2">
            <div>
              <label>Reduce longitud (%)</label>
              <input id="i-reduce" type="range" min="0" max="60" value="25"/>
              <div class="hint">Consejo: 20‚Äì30% suele funcionar bien.</div>
            </div>
            <div>
              <label>Objetivo palabras (~)</label>
              <input id="i-words" type="number" min="60" max="500" value="160"/>
              <div class="hint">Ajusta seg√∫n el ‚Äúproducto‚Äù que pides.</div>
            </div>
          </div>

          <div>
            <label>Qu√© quieres mejorar (toca)</label>
            <div class="chips" id="i-mejoras">
              <div class="chip">m√°s claro y directo</div>
              <div class="chip">m√°s ejemplos cotidianos</div>
              <div class="chip">mejor alineaci√≥n a criterios</div>
              <div class="chip">m√°s evidencias observables</div>
              <div class="chip">formato tabla</div>
              <div class="chip">entrega por partes</div>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Comentario (opcional)</label>
              <input id="i-coment" placeholder="p.ej., ‚Äòme faltan apoyos NEAE y una r√∫brica‚Äô"/>
            </div>
            <div>
              <label>Forzar preguntas antes de asumir</label>
              <select id="i-preguntar"><option selected>s√≠</option><option>no</option></select>
            </div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="i-gen" type="button">Generar mensaje de mejora</button>
            <button class="btn" id="i-copy" type="button">Copiar</button>
          </div>

          <pre><button class="btn copy" type="button">Copiar</button><code id="i-out"></code></pre>
        </div>
      </section>

      <!-- 3) PLANTILLAS -->
      <section id="plantillas" class="card">
        <h2>3) Plantillas r√°pidas (listas para aula)</h2>
        <p class="lead">Para demostrar capacidad en directo: copias, pegas y ajustas.</p>

        <details>
          <summary><span class="pill">Q</span> Acuerdo de calidad (para cualquier petici√≥n)</summary>
<pre><button class="btn copy" type="button">Copiar</button><code>Act√∫a como docente experto en LOMLOE (Canarias). Si falta informaci√≥n, preg√∫ntame antes de asumir. Alinea a criterios y saberes (c√≥digos visibles) y a√±ade evidencias observables + instrumento. Entrega por partes y espera mi OK. Lenguaje inclusivo, claro y no violento.</code></pre>
        </details>

        <details>
          <summary><span class="pill">E</span> Prueba por preguntas (paso a paso)</summary>
<pre><button class="btn copy" type="button">Copiar</button><code>Vamos a elaborar una prueba de [N] preguntas para [Etapa/Curso/Materia]. Empezamos por la 1: dame 3 propuestas alineadas con [C√ìDIGOS]. Incluye: (a) enunciado, (b) soluci√≥n breve, (c) criterio con c√≥digo, (d) evidencia observable. Tras elegir, pasamos a la 2, etc.</code></pre>
        </details>

        <details>
          <summary><span class="pill">S</span> SdA completa (con evaluaci√≥n por criterios)</summary>
<pre><button class="btn copy" type="button">Copiar</button><code>Dise√±a una SdA para [Etapa/Curso/Materia] con producto final [X]. Incluye: contexto, objetivos, competencias espec√≠ficas, criterios (c√≥digos), saberes, tareas secuenciadas, atenci√≥n a la diversidad (DUA + NEAE + ampliaci√≥n), instrumentos de evaluaci√≥n y evidencias observables por criterio.</code></pre>
        </details>

        <details>
          <summary><span class="pill">O</span> Overleaf/LaTeX (Beamer) ‚Äî presentaci√≥n</summary>
<pre><button class="btn copy" type="button">Copiar</button><code>Genera el guion y el c√≥digo LaTeX (Beamer) para una presentaci√≥n de [TEMA] en [Etapa/Curso]. Incluye: 1) objetivos, 2) explicaci√≥n breve con ejemplos, 3) 3 actividades, 4) mini-evaluaci√≥n final, 5) cierre. Estilo claro, sin exceso de texto.</code></pre>
        </details>
      </section>

    </div>
  </main>

  <!-- Bottom actions -->
  <nav class="bottom" aria-label="Acciones r√°pidas">
    <div class="container bar">
      <a class="btn primary" href="https://chatgpt.com" target="_blank" rel="noopener">Abrir ChatGPT</a>
      <button class="btn" id="quick-copy" type="button">Copiar prompt</button>
      <button class="btn" id="quick-more" type="button">M√°s</button>
    </div>
  </nav>

  <!-- More panel + backdrop -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>
  <div class="more-panel" id="more-panel" aria-hidden="true">
    <div class="more-card" role="dialog" aria-label="Opciones">
      <div class="more-head">
        <div>Opciones</div>
        <button class="btn ghost" id="more-close" type="button">Cerrar</button>
      </div>
      <div class="more-actions">
        <button class="btn" id="more-share" type="button">Compartir enlace</button>
        <button class="btn" id="more-demo" type="button">Demo r√°pida</button>
        <button class="btn" id="more-reset" type="button">Reset</button>
        <button class="btn" id="more-top" type="button">Arriba</button>
      </div>
      <div class="hint" style="padding:0 12px 12px">
        Tip: el enlace compartido puede llevar valores pre-rellenados (ideal para QR por etapa/curso).
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // ---------- Toast ----------
    let toastTimer=null;
    function showToast(msg){
      const t = $('#toast');
      if(!t) return;
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.style.display='none', 1400);
    }

    // ---------- Theme ----------
    const themeKey='gen-docente-theme';
    const saved=localStorage.getItem(themeKey);
    if(saved) document.documentElement.style.colorScheme=saved;
    $('#theme')?.addEventListener('click',()=>{
      const cur=document.documentElement.style.colorScheme;
      const next=cur==='light'?'dark':'light';
      document.documentElement.style.colorScheme=next;
      localStorage.setItem(themeKey,next);
      showToast(next==='light' ? 'Tema claro' : 'Tema oscuro');
    });

    // ---------- Step highlight ----------
    const stepLinks=$$('#steps a');
    const map={};
    stepLinks.forEach(a=> map[a.getAttribute('href').slice(1)]=a);
    const io=new IntersectionObserver(entries=>{
      entries.forEach(ent=>{
        if(ent.isIntersecting){
          stepLinks.forEach(a=>a.classList.remove('active'));
          const id=ent.target.id;
          if(map[id]) map[id].classList.add('active');
        }
      });
    }, {root:null, rootMargin:'-55% 0px -45% 0px', threshold:0});
    $$('main section').forEach(sec=> io.observe(sec));

    // ---------- Chips ----------
    function toggleChip(e){
      e.currentTarget.classList.toggle('active');
      saveStateSoon();
    }
    $$('.chip').forEach(c=> c.addEventListener('click', toggleChip));

    // ---------- Copy helper ----------
    async function copyText(t){
      try{
        await navigator.clipboard.writeText(t || '');
        return true;
      }catch{
        try{
          const ta=document.createElement('textarea');
          ta.value=t || '';
          ta.style.position='fixed';
          ta.style.left='-9999px';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          document.execCommand('copy');
          ta.remove();
          return true;
        }catch{
          return false;
        }
      }
    }

    // Copy buttons inside <pre>
    $$('.copy').forEach(btn=> btn.addEventListener('click', async e=>{
      const codeEl=e.target.parentElement.querySelector('code');
      const t=codeEl ? codeEl.innerText : '';
      const ok=await copyText(t);
      showToast(ok ? 'Copiado ‚úì' : 'No se pudo copiar');
    }));

    // ---------- Dynamic "Metodolog√≠a / Tipo de prueba" ----------
    const teachingOptions = [
      'mixta (explicaci√≥n + pr√°ctica guiada)',
      'flipped classroom (clase invertida)',
      'clase magistral (exposici√≥n docente)',
      'aprendizaje basado en proyectos (ABP)',
      'aprendizaje cooperativo',
      'indagaci√≥n / aprendizaje por descubrimiento',
      'gamificaci√≥n',
      'aprendizaje-servicio (ApS)'
    ];

    const testOptions = [
      'prueba escrita tipo test (A/B/C/D)',
      'prueba escrita de respuesta corta',
      'prueba escrita de desarrollo / problemas',
      'prueba pr√°ctica / desempe√±o (tarea en aula)',
      'prueba oral (preguntas + r√∫brica)',
      'exposici√≥n oral evaluable (r√∫brica)'
    ];

    function setSelectOptions(selectEl, options, selectedIndex=0){
      if(!selectEl) return;
      selectEl.innerHTML = '';
      options.forEach((t,i)=>{
        const opt=document.createElement('option');
        opt.textContent=t;
        if(i===selectedIndex) opt.selected=true;
        selectEl.appendChild(opt);
      });
    }

    function syncMetodoWithProducto(){
      const prod = ($('#p-producto')?.value || '').toLowerCase();
      const isPrueba = prod.includes('prueba');

      const label = $('#p-metodo-label');
      const sel = $('#p-metodo');
      const hint = $('#p-metodo-hint');

      const modalidadWrap = $('#modalidad-wrap');
      const modalidadSel = $('#p-modalidad');

      if(isPrueba){
        if(label) label.textContent = 'Tipo de prueba (c√≥mo vas a evaluar)';
        if(hint) hint.textContent = 'Elige el formato de evaluaci√≥n (escrita/oral/pr√°ctica).';
        const cur = sel?.value || '';
        const idx = testOptions.findIndex(x=>x===cur);
        setSelectOptions(sel, testOptions, idx>=0?idx:0);

        if(modalidadWrap) modalidadWrap.style.display = 'none';
        if(modalidadSel) modalidadSel.value = '';
      }else{
        if(label) label.textContent = 'Metodolog√≠a (c√≥mo vas a ense√±ar)';
        if(hint) hint.textContent = 'C√≥mo vas a desarrollar la ense√±anza (ABP, cooperativo, flipped‚Ä¶).';
        const cur = sel?.value || '';
        const idx = teachingOptions.findIndex(x=>x===cur);
        setSelectOptions(sel, teachingOptions, idx>=0?idx:0);

        if(modalidadWrap) modalidadWrap.style.display = '';
      }

      saveStateSoon();
    }

    $('#p-producto')?.addEventListener('change', syncMetodoWithProducto);

    // ---------- Optional flags (only include if user touched) ----------
    let ajustesUsed=false;
    let docsUsed=false;
    const markUsed=(wrapId, setter)=>{
      const wrap=document.getElementById(wrapId);
      if(!wrap) return;
      wrap.addEventListener('input', ()=>{setter(true); saveStateSoon();}, {passive:true});
      wrap.addEventListener('change', ()=>{setter(true); saveStateSoon();}, {passive:true});
    };
    markUsed('ajustes-wrap', v=>{ajustesUsed=v;});
    markUsed('docs-wrap', v=>{docsUsed=v;});

    // ---------- Validation ----------
    function clearInvalid(){
      $$('input.invalid,select.invalid,textarea.invalid').forEach(el=> el.classList.remove('invalid'));
    }
    $$('input,select,textarea').forEach(el=>{
      el.addEventListener('input', ()=> el.classList.remove('invalid'), {passive:true});
      el.addEventListener('change', ()=> el.classList.remove('invalid'), {passive:true});
    });

    function requireField(id, label){
      const el = document.getElementById(id);
      if(!el) return true;
      const v = (el.value || '').trim();
      if(!v){
        el.classList.add('invalid');
        showToast(`Completa: ${label}`);
        el.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=> el.focus?.(), 250);
        return false;
      }
      return true;
    }

    // ---------- Prompt builders ----------
    function buildBase(){
      const prod=$('#p-producto')?.value || '[PRODUCTO]';
      const materia=($('#p-materia')?.value || '').trim() || '[MATERIA]';
      const etapa=$('#p-etapa')?.value || '[ETAPA]';
      const curso=$('#p-curso')?.value || '[CURSO]';
      const objetivo=($('#p-objetivo')?.value || '').trim() || '[OBJETIVO]';
      const perfil=($('#p-perfil')?.value || '').trim() || '[PERFIL]';
      const metodo=$('#p-metodo')?.value || 'mixta (explicaci√≥n + pr√°ctica guiada)';
      const dinamica=$('#p-modalidad')?.value || 'resoluci√≥n de tareas en aula (pr√°ctica guiada)';

      const comp=($('#p-comp')?.value || '').trim();
      const cc=($('#p-cc')?.value || '').trim();
      const crit=($('#p-criterios')?.value || '').trim() || '[CRITERIOS]';
      const sab=($('#p-saberes')?.value || '').trim() || '[SABERES]';

      const tono=$('#p-tono')?.value || 'did√°ctico y claro';
      const formato=$('#p-formato')?.value || 'texto por apartados (LOMLOE)';
      const long=$('#p-long')?.value || 'breve';

      // Chips (base)
      const opts={};
      $$('#p-opc .chip.active').forEach(ch=>{ if(ch.dataset.key) opts[ch.dataset.key]=true; });

      const idioma='espa√±ol (Canarias)';

      let txt = `Act√∫a como docente con experiencia en LOMLOE (Canarias). `;
      txt += `Necesito ${prod} para ${materia}, ${etapa} ${curso}. `;
      txt += `Grupo: ${perfil}. Objetivo: ${objetivo}. `;

      const isPrueba = (prod || '').toLowerCase().includes('prueba');
      if(isPrueba){
        txt += `Tipo de prueba: ${metodo}. `;
      }else{
        txt += `Metodolog√≠a: ${metodo}. Din√°mica de aula: ${dinamica}. `;
      }

      txt += `Idioma: ${idioma}. Tono: ${tono}. `;

      if(comp) txt += `Competencias espec√≠ficas (c√≥digo + texto): ${comp}. `;
      if(cc) txt += `Competencias clave: ${cc}. `;
      txt += `Criterios de evaluaci√≥n (c√≥digo + texto): ${crit}. `;
      txt += `Saberes b√°sicos: ${sab}. `;

      txt += `Devu√©lvelo en ${formato}. Longitud: ${long}. `;

      if(opts.pasos) txt += `Entrega por partes y espera mi OK para continuar. `;
      if(opts.dua) txt += `Aplica DUA: consignas claras, apoyos visuales, alternativas de acceso y expresi√≥n. `;
      if(opts.codigos) txt += `Muestra el c√≥digo de criterio junto a cada apartado/√≠tem. `;
      if(opts.evidencias) txt += `Incluye evidencias observables y el instrumento de evaluaci√≥n (r√∫brica/lista de cotejo/escala). `;
      if(opts.preguntas) txt += `Si falta informaci√≥n, preg√∫ntame 3 cosas clave antes de generar (nivel, tiempo, evaluaci√≥n). `;

      return txt.replace(/\s+/g,' ').trim();
    }

    function buildAjustesInternal(){
      const rol=$('#a-rol')?.value || 'profesor/a (especialista en tu materia)';
      const estilo=$('#a-estilo')?.value || 'muy pr√°ctico (listo para aula)';
      const notas=($('#a-notas')?.value || '').trim();

      const neae=$('#a-neae')?.value || 'ligero';
      const ac=$('#a-ac')?.value || 'no';
      const bloom=$('#a-bloom')?.value || 'aplicar / resolver';
      const ej=$('#a-ej')?.value || '2';

      const evid=[];
      $$('#a-evid .chip.active').forEach(ch=> evid.push(ch.textContent.trim()));

      const inst=$('#a-inst')?.value || 'r√∫brica';
      const escala=$('#a-escala')?.value || '4 niveles (Inicial ‚Üí Excelente)';

      const contexto=($('#a-contexto')?.value || '').trim();
      const restr=($('#a-restr')?.value || '').trim();
      const formato=$('#a-formato')?.value || 'texto por apartados';

      let txt = `Ajustes de respuesta: responde como ${rol} con estilo ${estilo}`;
      if(notas) txt += ` (${notas})`;
      txt += `. `;

      if(neae && neae !== 'ninguno') txt += `Incluye apoyos NEAE (${neae}). `;
      if(ac === 's√≠') txt += `Incluye una opci√≥n de ampliaci√≥n. `;
      if(bloom) txt += `Nivel cognitivo: ${bloom}. `;
      if(ej && ej !== '0') txt += `Incluye ${ej} ejemplo(s) breves por bloque/√≠tem si ayuda. `;

      if(evid.length) txt += `Evidencias a priorizar: ${evid.join(', ')}. `;
      if(inst) txt += `Instrumento: ${inst}. `;
      if(escala) txt += `Escala: ${escala}. `;

      if(contexto) txt += `Contexto: ${contexto}. `;
      if(restr) txt += `Restricciones: ${restr}. `;
      if(formato) txt += `Formato final: ${formato}. `;

      return txt.replace(/\s+/g,' ').trim();
    }

    function buildDocsInternal(){
      const o=($('#d-orden')?.value || '').trim() || '[ORDEN ESPEC√çFICA]';
      const e=($('#d-ejemplo')?.value || '').trim();
      let txt = `Documentaci√≥n adjunta (FUENTE PRIORITARIA): Orden espec√≠fica / condiciones: ${o}. `;
      txt += `Respeta estas condiciones por encima de supuestos generales. Si algo no encaja, ind√≠calo y preg√∫ntame. `;
      if(e) txt += `Usa este ejemplo propio como est√°ndar de calidad (formato, nivel y estilo): ${e}. `;
      return txt.replace(/\s+/g,' ').trim();
    }

    function buildFinal(){
      const base = buildBase();

      let aj = '';
      if(ajustesUsed) aj = buildAjustesInternal();

      const o = ($('#d-orden')?.value || '').trim();
      const e = ($('#d-ejemplo')?.value || '').trim();
      let docs = '';
      if(docsUsed || o || e) docs = buildDocsInternal();

      const parts=[base];
      if(aj) parts.push(aj);
      if(docs) parts.push(docs);

      const full = parts.join(' ').replace(/\s+/g,' ').trim();
      const out=$('#m-out');
      if(out) out.value = full;

      saveStateSoon();
      return full;
    }

    // ---------- Buttons: Prompt final ----------
    $('#m-build')?.addEventListener('click', ()=>{
      clearInvalid();
      const ok1 = requireField('p-materia', 'Materia');
      const ok2 = requireField('p-objetivo', 'Objetivo did√°ctico');
      if(!ok1 || !ok2) return;

      const prompt = buildFinal();
      showToast(prompt ? 'Prompt generado ‚úì' : 'No se pudo generar');
      // Soft tip if criterios/saberes empty
      const crit = ($('#p-criterios')?.value || '').trim();
      const sab = ($('#p-saberes')?.value || '').trim();
      if(!crit && !sab) setTimeout(()=> showToast('Tip: pega criterios/saberes para m√°xima precisi√≥n'), 900);
    });

    $('#m-copy')?.addEventListener('click', async ()=>{
      const t = ($('#m-out')?.value || '').trim() || buildFinal();
      const ok=await copyText(t);
      showToast(ok ? 'Copiado ‚úì' : 'No se pudo copiar');
    });

    $('#m-dl')?.addEventListener('click', ()=>{
      const t = ($('#m-out')?.value || '').trim() || buildFinal();
      const blob = new Blob([t], {type:'text/plain'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='prompt_final_LOMLOE.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
      showToast('Descarga lista ‚úì');
    });

    // ---------- Share link (prefill) ----------
    function buildShareURL(){
      const prod = $('#p-producto')?.value || '';
      const reverseProd = (v)=>{
        const m = {
          "prueba (evaluaci√≥n)":"prueba",
          "situaci√≥n de aprendizaje (SdA) con producto final":"sda",
          "tarea competencial (actividad final + evaluaci√≥n)":"tarea",
          "r√∫brica (4 niveles) con descriptores observables":"rubrica",
          "programaci√≥n de unidad/SdA por apartados (LOMLOE)":"programacion",
          "adaptaci√≥n curricular individualizada (NEAE) ‚Äî objetivos, actividades y evaluaci√≥n adaptada":"acineae",
          "gu√≠a docente para impartir un tema (plan de sesiones + recursos + evaluaci√≥n)":"guia",
          "guion de diapositivas para Overleaf/LaTeX Beamer":"latex",
          "cuestionario Moodle en formato GIFT":"moodle"
        };
        return m[v] || "";
      };

      const url = new URL(location.href);
      url.search = "";
      url.searchParams.set("producto", reverseProd(prod));
      url.searchParams.set("materia", $('#p-materia')?.value || "");
      url.searchParams.set("etapa", $('#p-etapa')?.value || "");
      url.searchParams.set("curso", $('#p-curso')?.value || "");
      // opcionales (solo si est√°n)
      const obj = ($('#p-objetivo')?.value || '').trim();
      const perf = ($('#p-perfil')?.value || '').trim();
      if(obj) url.searchParams.set("objetivo", obj);
      if(perf) url.searchParams.set("perfil", perf);
      return url.toString();
    }

    async function shareLink(){
      const link = buildShareURL();
      const ok = await copyText(link);
      showToast(ok ? 'Enlace copiado ‚úì' : 'No se pudo copiar enlace');
      return link;
    }

    $('#m-share')?.addEventListener('click', shareLink);

    // ---------- Quick copy ----------
    $('#quick-copy')?.addEventListener('click', async ()=>{
      const t = ($('#m-out')?.value || '').trim() || buildFinal();
      const ok=await copyText(t);
      showToast(ok ? 'Copiado ‚úì' : 'No se pudo copiar');
    });

    // ---------- Improve builder ----------
    function buildImprove(){
      const reduce=$('#i-reduce')?.value || 25;
      const words=$('#i-words')?.value || 160;
      const cmt=($('#i-coment')?.value || '').trim();
      const ask=$('#i-preguntar')?.value || 's√≠';
      const feats=[];
      $$('#i-mejoras .chip.active').forEach(ch=> feats.push(ch.textContent.trim()));
      const improvements = feats.length ? feats.join(', ') : 'ajusta seg√∫n lo anterior';

      let txt = `${cmt ? ('Comentario: ' + cmt + '. ') : ''}`;
      txt += `Me gusta la base, pero reduce la longitud un ${reduce}% y apunta a ~${words} palabras. `;
      txt += `Adem√°s: ${improvements}. Mant√©n criterios/saberes (c√≥digos visibles) y a√±ade evidencias observables.`;
      if(ask==='s√≠') txt += ` Si falta informaci√≥n, preg√∫ntame antes de asumir.`;

      const outEl=$('#i-out');
      if(outEl) outEl.innerText = txt;
      saveStateSoon();
      return txt;
    }

    $('#i-gen')?.addEventListener('click', ()=>{
      buildImprove();
      showToast('Mensaje de mejora generado ‚úì');
    });

    $('#i-copy')?.addEventListener('click', async ()=>{
      const t=($('#i-out')?.innerText || '').trim() || buildImprove();
      const ok=await copyText(t);
      showToast(ok ? 'Copiado ‚úì' : 'No se pudo copiar');
    });

    // ---------- State: autosave / restore ----------
    const stateKey = 'curso_prompts_lomloe_canarias_v1';
    let saveTimer=null;

    function collectState(){
      const fields = {};
      $$('input,select,textarea').forEach(el=>{
        if(!el.id) return;
        fields[el.id] = el.value;
      });

      // chips by container id: store keys or text
      const chips = {};
      ['p-opc','a-evid','i-mejoras'].forEach(cid=>{
        const wrap = document.getElementById(cid);
        if(!wrap) return;
        const active = Array.from(wrap.querySelectorAll('.chip.active')).map(ch=> ch.dataset.key || ch.textContent.trim());
        chips[cid] = active;
      });

      return {
        fields,
        chips,
        flags:{ajustesUsed, docsUsed},
        ts: Date.now()
      };
    }

    function applyState(state){
      if(!state || !state.fields) return;

      // Set field values if present
      Object.entries(state.fields).forEach(([id,val])=>{
        const el = document.getElementById(id);
        if(!el) return;
        // For range/number/text/select/textarea all via value
        el.value = val ?? '';
      });

      // Chips restore
      if(state.chips){
        Object.entries(state.chips).forEach(([cid, arr])=>{
          const wrap = document.getElementById(cid);
          if(!wrap) return;
          const wanted = new Set(arr || []);
          wrap.querySelectorAll('.chip').forEach(ch=>{
            const key = ch.dataset.key || ch.textContent.trim();
            if(wanted.has(key)) ch.classList.add('active');
            else ch.classList.remove('active');
          });
        });
      }

      if(state.flags){
        ajustesUsed = !!state.flags.ajustesUsed;
        docsUsed = !!state.flags.docsUsed;
      }
    }

    function saveState(){
      try{
        localStorage.setItem(stateKey, JSON.stringify(collectState()));
      }catch{}
    }

    function saveStateSoon(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveState, 250);
    }

    // Save on any input changes
    $$('input,select,textarea').forEach(el=>{
      el.addEventListener('input', saveStateSoon, {passive:true});
      el.addEventListener('change', saveStateSoon, {passive:true});
    });

    // ---------- Prefill from URL (QR-friendly) ----------
    function prefillFromURL(){
      const p = new URLSearchParams(location.search);
      if(!p || Array.from(p.keys()).length === 0) return;

      const set = (id, key) => {
        const el = document.getElementById(id);
        const val = p.get(key);
        if(el && val) el.value = decodeURIComponent(val);
      };

      const prodMap = {
        prueba: "prueba (evaluaci√≥n)",
        sda: "situaci√≥n de aprendizaje (SdA) con producto final",
        tarea: "tarea competencial (actividad final + evaluaci√≥n)",
        rubrica: "r√∫brica (4 niveles) con descriptores observables",
        programacion: "programaci√≥n de unidad/SdA por apartados (LOMLOE)",
        acineae: "adaptaci√≥n curricular individualizada (NEAE) ‚Äî objetivos, actividades y evaluaci√≥n adaptada",
        guia: "gu√≠a docente para impartir un tema (plan de sesiones + recursos + evaluaci√≥n)",
        latex: "guion de diapositivas para Overleaf/LaTeX Beamer",
        moodle: "cuestionario Moodle en formato GIFT"
      };

      const prodKey = p.get("producto");
      if(prodKey && $('#p-producto')){
        $('#p-producto').value = prodMap[prodKey] || $('#p-producto').value;
      }

      set("p-materia","materia");
      set("p-etapa","etapa");
      set("p-curso","curso");
      set("p-objetivo","objetivo");
      set("p-perfil","perfil");

      // After product changes, resync mode
      syncMetodoWithProducto();
      saveStateSoon();
      showToast('Valores cargados desde enlace ‚úì');
    }

    // ---------- Demo / Reset ----------
    function applyDemo(){
      // Demo editable (no cerrado): rellena m√≠nimo para probar el flujo en 15s.
      $('#p-producto').value = "situaci√≥n de aprendizaje (SdA) con producto final";
      $('#p-materia').value = "Lengua Castellana y Literatura";
      $('#p-etapa').value = "ESO";
      $('#p-curso').value = "1.¬∫";
      $('#p-objetivo').value = "Mejorar la comprensi√≥n lectora y la expresi√≥n escrita con una tarea final breve.";
      $('#p-perfil').value = "Grupo heterog√©neo con ritmos diversos; incluir apoyos NEAE.";
      // Chips recomendados
      $$('#p-opc .chip').forEach(ch=> ch.classList.remove('active'));
      $$('#p-opc .chip[data-key="pasos"], #p-opc .chip[data-key="codigos"], #p-opc .chip[data-key="evidencias"]').forEach(ch=> ch.classList.add('active'));

      syncMetodoWithProducto();
      ajustesUsed = false;
      docsUsed = false;
      $('#m-out').value = '';
      saveStateSoon();
      showToast('Demo cargada ‚úì (edita y genera)');
      $('#generar').scrollIntoView({behavior:'smooth', block:'start'});
    }

    function resetAll(){
      const ok = confirm('¬øResetear todo? Se borrar√°n campos y ajustes guardados.');
      if(!ok) return;
      try{ localStorage.removeItem(stateKey); }catch{}
      // Clear fields
      $$('input,textarea').forEach(el=>{ if(el.id) el.value=''; });
      $$('select').forEach(el=>{ /* keep defaults */ });
      // Reset selects to first option where appropriate
      $('#p-producto').value = "prueba (evaluaci√≥n)";
      $('#p-etapa').value = "ESO";
      $('#p-curso').value = "1.¬∫";
      $('#p-tono').value = "did√°ctico y claro";
      $('#p-formato').value = "texto por apartados (LOMLOE)";
      $('#p-long').value = "breve";

      // Reset improvements defaults
      $('#i-reduce').value = 25;
      $('#i-words').value = 160;
      $('#i-preguntar').value = "s√≠";
      $('#i-out').innerText = "";

      // Chips off
      $$('.chip').forEach(ch=> ch.classList.remove('active'));

      ajustesUsed=false; docsUsed=false;
      clearInvalid();

      syncMetodoWithProducto();
      $('#m-out').value='';
      saveStateSoon();
      showToast('Reseteado ‚úì');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // ---------- M√°s panel ----------
    const morePanel = $('#more-panel');
    const backdrop = $('#backdrop');
    function openMore(){
      if(!morePanel || !backdrop) return;
      morePanel.style.display='block';
      backdrop.style.display='block';
      morePanel.setAttribute('aria-hidden','false');
      backdrop.setAttribute('aria-hidden','false');
    }
    function closeMore(){
      if(!morePanel || !backdrop) return;
      morePanel.style.display='none';
      backdrop.style.display='none';
      morePanel.setAttribute('aria-hidden','true');
      backdrop.setAttribute('aria-hidden','true');
    }
    $('#quick-more')?.addEventListener('click', openMore);
    $('#more-close')?.addEventListener('click', closeMore);
    backdrop?.addEventListener('click', closeMore);

    $('#more-share')?.addEventListener('click', async ()=>{
      await shareLink();
      closeMore();
    });
    $('#more-demo')?.addEventListener('click', ()=>{
      applyDemo();
      closeMore();
    });
    $('#more-reset')?.addEventListener('click', ()=>{
      resetAll();
      closeMore();
    });
    $('#more-top')?.addEventListener('click', ()=>{
      window.scrollTo({top:0, behavior:'smooth'});
      closeMore();
    });

    // ---------- Init: restore -> sync -> prefill URL override ----------
    (function init(){
      // Restore saved state (if any)
      try{
        const raw = localStorage.getItem(stateKey);
        if(raw){
          const state = JSON.parse(raw);
          applyState(state);
        }
      }catch{}

      // Ensure select options and mode are correct
      syncMetodoWithProducto();

      // URL prefill overrides local (useful for QR)
      prefillFromURL();

      // If nothing in output, keep empty (avoid confusion)
      if(!($('#m-out')?.value || '').trim()) $('#m-out').value = '';
    })();
  </script>
</body>
</html>

